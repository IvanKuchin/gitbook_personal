# Minikube

## Cheatsheet

```
minikube start
minikube status
minikube stop
minikube delete
```

#### Addons

```
minikube addons list
minikube addons enable dashboard
minikube addons enable ingress
```

#### Display NodePort exposed on node

```
minikube service <service name> [--url] 
```

#### Dashboard/proxy:

```
minikube dashboard
minikube dashboard --url
```

#### Worker nodes

```
minikube node list 
minikube node add
```

#### Allocate compute resources to minikube

```
minikube start --cpus=4 --memory 4096
```

#### SSH to minikube VM

```
kubectl get nodes -o wide

ssh docker@<node IP>
password: tcuser
```

or

```
minikube ssh
```

## Start on Ubuntu 20.04

According to [https://blog.pilosus.org/posts/2019/05/18/minikube-hight-cpu-usage-linux/](https://blog.pilosus.org/posts/2019/05/18/minikube-hight-cpu-usage-linux/) and [https://minikube.sigs.k8s.io/docs/drivers/](https://minikube.sigs.k8s.io/docs/drivers/)

![](../.gitbook/assets/k8s\_minikube\_driver.png)

It is recommended to use –vm-driver=kvm2

{% hint style="warning" %}
Without kvm2 drivers there was a problem with Elasticsearch VM. It was stuck at a starting stage with CPU went up to 100%.
{% endhint %}

To install kvm-drivers follow steps here: [https://help.ubuntu.com/community/KVM/Installation](https://help.ubuntu.com/community/KVM/Installation)

Final start command:

```
minikube delete
minikube start –-cpus=16 –-memory=24G –-insecure-registry=”registry.local:5000” –-vm-driver=kvm2
```

{% hint style="warning" %}
All minikube settings must be set at first startub of a cluster.
{% endhint %}

## ISSUE: minikube: Incorrect Pod CIDR assignment or POD IP duplication

{% embed url="https://github.com/kubernetes/minikube/issues/10382" %}

## ISSUE: error when creating "ingress.yaml": Internal error occurred: failed calling webhook "validate.nginx.ingress.kubernetes.io"

```
kubectl get validatingwebhookconfigurations  
```

Expected output:

```
NAME                      WEBHOOKS   AGE
ingress-nginx-admission   1          9d
```

Delete webhookconfig

```
kubectl delete validatingwebhookconfigurations ingress-nginx-admission
```

Expected output:

```
validatingwebhookconfiguration.admissionregistration.k8s.io "ingress-nginx-admission" deleted
```

## Access to service via browser

```
kubectl create deployment –-image=nginx test
kubectl expose deployment test -–type=NodePort –-port=80
```

Check minikube exposure:

```
minikube service list 
```

or

```
minikube service test
```

```
|-----------|------|-------------|-----------------------------|
| NAMESPACE | NAME | TARGET PORT |             URL             |
|-----------|------|-------------|-----------------------------|
| default   | test |          80 | http://192.168.99.111:31732 |
|-----------|------|-------------|-----------------------------|
* Opening service default/test in default browser...
  - http://192.168.99.111:31732

```

## Ubuntu/minikube routing and interfaces

![](../.gitbook/assets/k8s\_minikube\_netw.png)

## NAT on ubuntu to access K8s ingress from the outside

{% embed url="https://serverfault.com/questions/586486/how-to-do-the-port-forwarding-from-one-ip-to-another-ip-in-same-network" %}

{% hint style="warning" %}
Note: src IP must be vxnet-iface IP (192.168.99.1), not the eth0 (must be in the same subnet). Otherwise, it won’t work.
{% endhint %}

```
more /etc/iptables/rules.v4 
# Generated by iptables-save v1.8.4 on Fri Jun 25 02:56:39 2021
*nat
:PREROUTING ACCEPT [45:2340]
:INPUT ACCEPT [45:2340]
:OUTPUT ACCEPT [2:312]
:POSTROUTING ACCEPT [2:312]
-A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.99.111:80
-A PREROUTING -p tcp -m tcp --dport 7681 -j DNAT --to-destination 192.168.99.111:7681
-A POSTROUTING -d 192.168.99.111/32 -p tcp -m tcp --dport 80 -j SNAT --to-source 192.168.99.1
-A POSTROUTING -d 192.168.99.111/32 -p tcp -m tcp --dport 7681 -j SNAT --to-source 192.168.99.1
COMMIT
# Completed on Fri Jun 25 02:56:39 2021
# Generated by iptables-save v1.8.4 on Fri Jun 25 02:56:39 2021
*filter
:INPUT ACCEPT [78869:46037532]
:FORWARD ACCEPT [527:434332]
:OUTPUT ACCEPT [78652:45430026]
COMMIT
# Completed on Fri Jun 25 02:56:39 2021

```

## Port forwarding on ingress nginx

{% embed url="https://minikube.sigs.k8s.io/docs/tutorials/nginx_tcp_udp_ingress" %}

Step 1) Check tcp-services

```
kubectl get configmaps -n ingress-nginx tcp-services
```

Step 2) Patch tcp-services configmap

```
kubectl patch configmap tcp-services -n ingress-nginx --patch '{"data":{"7681":"www-connme-ru/chat-service:7681"}}'
```

Step 3) Check tcp-services

```
kubectl get configmaps -n ingress-nginx tcp-services
```

Expected output:

```
apiVersion: v1
data:
  "7681": www-connme-ru/chat-service:7681
kind: ConfigMap

```

Line (3) should shows port 7681

Step 4) check nginx controller patch

```
more ./ingress-nginx-controller-patch.yaml 
spec:
  template:
    spec:
      containers:
      - name: controller
        ports:
         - containerPort: 7681
           hostPort: 7681

```

Step 5) apply patch to nginx ingress

```
kubectl patch deployment -n ingress-nginx ingress-nginx-controller --patch "$(cat ingress-nginx-controller-patch.yaml)"
```

Step 6) Check correctness of patch

```
kubectl get deployment -n ingress-nginx ingress-nginx-controller -o yaml
```

```
        ports:
        - containerPort: 7681
          hostPort: 7681
          protocol: TCP
        - containerPort: 80
          hostPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          hostPort: 443
          name: https
          protocol: TCP
        - containerPort: 8443
```

Lines (2) - (4) expected to find tcp/7681

Step 7) Forward 7681 port on minikube host

Option 1) minikube vm-driver kvm2 (recommended)

```
more /etc/iptables/rules.v4                   
# Generated by iptables-save v1.8.4 on Tue Jul 20 02:58:07 2021
*nat
:PREROUTING ACCEPT [44:2648]
:INPUT ACCEPT [31:1852]
:OUTPUT ACCEPT [15:900]
:POSTROUTING ACCEPT [20:1160]
:LIBVIRT_PRT - [0:0]
-A PREROUTING -p tcp -m tcp --match multiport --dports 80,7681 -j DNAT --to-destination 192.168.122.32:80
# -A PREROUTING -p tcp -m tcp --dport 7681 -j DNAT --to-destination 192.168.122.32:7681
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -s 192.168.122.0/24 -d 224.0.0.0/24 -j RETURN
-A LIBVIRT_PRT -s 192.168.122.0/24 -d 255.255.255.255/32 -j RETURN
-A LIBVIRT_PRT -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A LIBVIRT_PRT -s 192.168.122.0/24 ! -d 192.168.122.0/24 -j MASQUERADE
COMMIT
# Completed on Tue Jul 20 02:58:07 2021
# Generated by iptables-save v1.8.4 on Tue Jul 20 02:58:07 2021
*filter
:INPUT ACCEPT [3854:1483110]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3806:1057309]
:LIBVIRT_FWI - [0:0]
:LIBVIRT_FWO - [0:0]
:LIBVIRT_FWX - [0:0]
:LIBVIRT_INP - [0:0]
:LIBVIRT_OUT - [0:0]
-A INPUT -j LIBVIRT_INP
-A FORWARD -j LIBVIRT_FWX
-A FORWARD -j LIBVIRT_FWI
-A FORWARD -j LIBVIRT_FWO
-A OUTPUT -j LIBVIRT_OUT
-A LIBVIRT_FWI -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWI -d 192.168.122.0/24 -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A LIBVIRT_FWI -d 192.168.122.0/24 -o virbr0 -j ACCEPT
-A LIBVIRT_FWI -o virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWO -s 192.168.122.0/24 -i virbr0 -j ACCEPT
-A LIBVIRT_FWO -i virbr0 -j REJECT --reject-with icmp-port-unreachable
-A LIBVIRT_FWX -i virbr1 -o virbr1 -j ACCEPT
-A LIBVIRT_FWX -i virbr0 -o virbr0 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p udp -m udp --dport 67 -j ACCEPT
-A LIBVIRT_INP -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr1 -p tcp -m tcp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p udp -m udp --dport 68 -j ACCEPT
-A LIBVIRT_OUT -o virbr0 -p tcp -m tcp --dport 68 -j ACCEPT
COMMIT
# Completed on Tue Jul 20 02:58:07 2021
# Generated by iptables-save v1.8.4 on Tue Jul 20 02:58:07 2021
*mangle
:PREROUTING ACCEPT [4097:1555015]
:INPUT ACCEPT [3884:1484910]
:FORWARD ACCEPT [213:70105]
:OUTPUT ACCEPT [3806:1057309]
:POSTROUTING ACCEPT [4019:1127414]
:LIBVIRT_PRT - [0:0]
-A POSTROUTING -j LIBVIRT_PRT
-A LIBVIRT_PRT -o virbr1 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A LIBVIRT_PRT -o virbr0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Tue Jul 20 02:58:07 2021
```

Line (9) - do an actual translation

Line (36) - open a pinhole in FW forwarding rules

Option 2) minikube vm-driver virtualbox

```
more /etc/iptables/rules.v4 
# Generated by iptables-save v1.8.4 on Fri Jun 25 02:56:39 2021
*nat
:PREROUTING ACCEPT [45:2340]
:INPUT ACCEPT [45:2340]
:OUTPUT ACCEPT [2:312]
:POSTROUTING ACCEPT [2:312]
-A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.99.111:80
-A PREROUTING -p tcp -m tcp --dport 7681 -j DNAT --to-destination 192.168.99.111:7681
-A POSTROUTING -d 192.168.99.111/32 -p tcp -m tcp --dport 80 -j SNAT --to-source 192.168.99.1
-A POSTROUTING -d 192.168.99.111/32 -p tcp -m tcp --dport 7681 -j SNAT --to-source 192.168.99.1
COMMIT
# Completed on Fri Jun 25 02:56:39 2021
# Generated by iptables-save v1.8.4 on Fri Jun 25 02:56:39 2021
*filter
:INPUT ACCEPT [78869:46037532]
:FORWARD ACCEPT [527:434332]
:OUTPUT ACCEPT [78652:45430026]
COMMIT
# Completed on Fri Jun 25 02:56:39 2021
```

Lines (9), (11) do the actual job

## Insecure registry

{% embed url="https://medium.com/@alombarte/setting-up-a-local-kubernetes-cluster-with-insecure-registries-f5aaa34851ae" %}

```
minikube start --insecure-registry="your.private.repo:PORT"
```

If you have started previously Minikube without the flag

```
minikube delete
```
