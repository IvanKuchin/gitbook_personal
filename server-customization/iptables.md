# iptables

## Basic config

```
more /etc/iptables/rules.v4
# Generated by iptables-save v1.6.0 on Fri May 25 17:20:26 2018
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4:200]
:UNTRUSTED-NETS - [0:0]
:TRUSTED-NETS - [0:0]
:RFC1918-NETS - [0:0]
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -j UNTRUSTED-NETS
-A INPUT -j RFC1918-NETS
-A INPUT -p tcp -m multiport --dports 20,21,5666 -j TRUSTED-NETS
-A INPUT -p icmp -j ACCEPT
-A INPUT -j DROP
-A UNTRUSTED-NETS -p tcp -m multiport --dports 22,25,80,443,53,7681 -j ACCEPT
-A UNTRUSTED-NETS -p udp -m multiport --dports 53,123 -j ACCEPT
-A TRUSTED-NETS -s 174.83.12.5/32 -j ACCEPT
-A TRUSTED-NETS -s 64.104.0.0/16 -j ACCEPT
-A TRUSTED-NETS -s 64.100.0.0/14 -j ACCEPT
-A TRUSTED-NETS -s 173.36.0.0/14 -j ACCEPT
-A RFC1918-NETS -s 176.100.241.208/28 -j ACCEPT
-A RFC1918-NETS -s 10.0.0.0/8 -j ACCEPT
-A RFC1918-NETS -s 172.16.0.0/12 -j ACCEPT
-A RFC1918-NETS -s 192.168.0.0/16 -j ACCEPT
-A RFC1918-NETS -s 127.0.0.1/32 -j ACCEPT
COMMIT
# Completed on Fri May 25 17:20:26 2018
```

| protocol:port | process            |
| ------------- | ------------------ |
| tcp:5666      | nagios-nrpe-server |
| tcp/udp:123   | NTP                |
| tcp:53        | DNS                |
| tcp:7681      | chat-server        |
| tcp:111       | portmapper         |
| tcp:2409      | NFS                |

## iptables DNS entry update

IPTABLES resolve DNS-names on start/restart. To update IPTABLES entry with new IP it requires restart. Here is daily update with backup.dynamic.conn-me.ru DNS-entry in /etc/cron.daily/nagios-monitoring

```
more /etc/cron.daily/nagios-monitoring 
#!/bin/bash

### update iptables to enable nagios to connect to server
iptables -R TRUSTED-NETS 1 -p tcp -s backup.dynamic.conn-me.ru -j ACCEPT
```

Line(5) uses DNS instead of IP



## SSH auth limit

{% hint style="warning" %}
Do NOT use MaxAuthTry in sshd-server config.&#x20;
{% endhint %}

{% embed url="https://unix.stackexchange.com/questions/418582/in-sshd-config-maxauthtries-limits-the-number-of-auth-failures-per-connection" %}

Limit ssh attempts by leveraging iptables module recent.

{% embed url="https://www.netfilter.org/documentation/HOWTO/netfilter-extensions-HOWTO-3.html#ss3.16" %}

```
sudo iptables -N SSHATTACK
sudo iptables -A SSHATTACK -j LOG --log-prefix "Possible SSH attack! " --log-level 7
sudo iptables -A SSHATTACK -j DROP

sudo iptables -N CUSTOM_FW
sudo iptables -A CUSTOM_FW -p tcp -m state --dport 22 --state NEW -m recent --set
sudo iptables -A CUSTOM_FW -p tcp -m state --dport 22 --state NEW -m recent --update --seconds 3600 --hitcount 4 -j SSHATTACK

sudo iptables -A INPUT -i ens160 -p tcp -m state --state NEW -j CUSTOM_FW

```

Lines (1) - (3) is basically DROP action + syslog

Lines (5) - (7) is tracker of src IP addresses, how many hits every IP did during second

Line (9) add FW-rules to INPUT chain



To check what IP been blocked:

```
cat -v /proc/net/xt_recent/DEFAULT
```

To add/remove IP to/from the blocked list

```
echo +192.168.4.7 >/proc/net/xt_recent/DEFAULT
echo -192.168.4.7 >/proc/net/xt_recent/DEFAULT
```
